<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="连接一个 IP 不存在的主机时，握手过程是怎么样的, yuxuanの博客">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>连接一个 IP 不存在的主机时，握手过程是怎么样的 | yuxuanの博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="yuxuanの博客" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yuxuanの博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives/" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about/" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yuxuanの博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/fyxemmmm/fyxemmmm.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/fyxemmmm/fyxemmmm.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://image.fyxemmmm.cn/blog/ins01/ins01-31.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">连接一个 IP 不存在的主机时，握手过程是怎么样的</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/tcp/">
                                <span class="chip bg-color">tcp</span>
                            </a>
                        
                            <a href="/tags/%E5%8D%8F%E8%AE%AE/">
                                <span class="chip bg-color">协议</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%8D%8F%E8%AE%AE/" class="post-category">
                                协议
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-02-02
                </div>
                

                

                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    14 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="正常情况的握手过程是怎么样的"><a href="#正常情况的握手过程是怎么样的" class="headerlink" title="正常情况的握手过程是怎么样的"></a>正常情况的握手过程是怎么样的</h2><p>上面提到的问题，其实是指<strong>TCP的三次握手流程</strong>。这绝对是面试八股文里的老股了。</p>
<p>我们<strong>简单回顾</strong>下基础知识点。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-1.jpg" alt="正常情况下的TCP三次握手"></p>
<p>在<strong>服务端</strong>启动好后会调用 <code>listen()</code> 方法，进入到 <code>LISTEN</code> 状态，然后静静等待<strong>客户端</strong>的连接请求到来。</p>
<p>而此时客户端主动调用 <code>connect(IP地址)</code> ，就会向某个IP地址发起<strong>第一次握手</strong>，发送<code>SYN</code> 到目的服务器。</p>
<p>服务器在收到第一次握手后就会响应客户端，这是<strong>第二次握手</strong>。</p>
<p>客户端在收到第二次握手的消息后，响应服务的一个<code>ACK</code>，这算<strong>第三次</strong>握手，此时客户端 就会进入 <code>ESTABLISHED</code>状态，认为连接已经建立完成。</p>
<p>通过抓包可以直观看出三次握手的流程。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-2.jpg" alt="正常三次握手抓包"></p>
<h2 id="连一个-IP-不存在的主机时，握手过程是怎样的"><a href="#连一个-IP-不存在的主机时，握手过程是怎样的" class="headerlink" title="连一个 IP 不存在的主机时，握手过程是怎样的"></a>连一个 IP 不存在的主机时，握手过程是怎样的</h2><p>那不存在的IP，分两种，<strong>局域网内和局域网外</strong>的。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-3.jpg" alt="家用路由器局域网互联"></p>
<p>我以我家里的情况举例。</p>
<p>家里有一台<strong>家用路由器</strong>。本质上它的功能已经集成了我们常说的<strong>路由器，交换机和无线接入点</strong>的功能了。</p>
<p>其中<strong>路由器和交换机</strong>在之前写过的 《<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzAwMDAxNjU4Mg==&amp;mid=2247484640&amp;idx=1&amp;sn=9c6fcd4c5973278e401188f32b54be97&amp;scene=21#wechat_redirect">硬核图解！30张图带你搞懂！路由器，集线器，交换机，网桥，光猫有啥区别？</a>》里已经详细介绍过了，就不再说一遍了。<strong>无线接入点</strong>基本可以认为就是个放出 wifi 信号的组件。</p>
<p>家用路由器下，连着我的N台设备，包括手机和电脑，他们的IP都有个<strong>共同点</strong>。都是 <code>192.168.31.xx</code> 形式的。其中，我的电脑的IP是<code>192.168.31.6</code> ，这个可以通过 <code>ifconfig</code>查到。</p>
<p>符合这个形式的这些个设备，本质上就是通过各种设备（wifi或交换机等）接入到<strong>上图路由器的e2端口</strong>，他们共同构成一个<strong>局域网</strong>。</p>
<p>因此，在我家，我们可以<strong>粗暴点</strong>认为只要是  <code>192.168.31.xx</code> 形式的IP，就是<strong>局域网内的IP</strong>。否则就是<strong>局域网外的IP</strong>，比如 <code>192.0.2.2</code> 。</p>
<h3 id="目的IP在局域网内"><a href="#目的IP在局域网内" class="headerlink" title="目的IP在局域网内"></a>目的IP在局域网内</h3><p>因为通过 ifconfig 可以查到我的局域网内IP是<code>192.168.31.6</code> ，这里<strong>盲猜</strong>末尾+1是不存在的 IP 。试了下，<code>192.168.31.7</code> 还真不存在。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ping</span> <span class="token number">192.168</span>.31.7
PING <span class="token number">192.168</span>.31.7 <span class="token punctuation">(</span><span class="token number">192.168</span>.31.7<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">0</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">1</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">2</span>
Request <span class="token function">timeout</span> <span class="token keyword">for</span> icmp_seq <span class="token number">3</span>
^C
--- <span class="token number">192.168</span>.31.7 <span class="token function">ping</span> statistics ---
<span class="token number">5</span> packets transmitted, <span class="token number">0</span> packets received, <span class="token number">100.0</span>% packet loss<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>于是写个程序尝试连这个IP 。下面的代码是 <code>golang</code> 写的，<strong>大家不看代码也没关系，放出来只是方便大家自己复现的时候用的。</strong></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// tcp客户端</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"io"</span>
    <span class="token string">"net"</span>
    <span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"192.168.31.7:8081"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">defer</span> client<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        input <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">{</span>
            n<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span>Stdin<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"input err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            client<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>input<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        n<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"read err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后尝试抓包。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-4.jpg" alt="连一个不存在的IP(局域网内)抓包"></p>
<p>可以发现根本没有三次握手的包，只有一些 ARP 包，在询问“谁是 <code>192.168.31.7</code>，告诉一下 <code>192.168.31.6</code>” 。</p>
<p>这里有三个问题</p>
<ul>
<li>为什么会发ARP请求？</li>
<li>为什么没有TCP握手包？</li>
<li>ARP本身是没有重试机制的，为什么ARP请求会发那么多遍？</li>
</ul>
<p>首先我们看下正常情况下执行<code>connect</code>，也就是第一次握手 的流程。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-5.jpg" alt="正常connect的流程"></p>
<p>应用层执行<code>connect</code>过后，会通过socket层，操作系统接口，进程会从<strong>用户态进入到内核态</strong>，此时进入 <strong>传输层</strong>，因为是<strong>TCP第一次握手</strong>，会加入<strong>TCP头</strong>，且置<strong>SYN</strong>标志。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-6.jpg" alt="tcp报头的SYN"></p>
<p>然后进入<strong>网络层</strong>，我想要连的是 <code>192.168.31.7</code> ，虽然它是我瞎编的，但<strong>IP头</strong>还是得老老实实把它加进去。</p>
<p>此时需要重点介绍的是<strong>邻居子系统</strong>，它在<strong>网络层和数据链路层之间</strong>。可以通过<strong>ARP协议将目的IP转为对应的MAC地址</strong>，然后<strong>数据链路层</strong>就可以用这个MAC地址组装<strong>帧头</strong>。</p>
<p>我们看下那么<strong>ARP协议的流程</strong>是</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-7.jpg" alt="ARP流程"></p>
<p>1.先到本地ARP表查一下有没有 <code>192.168.31.7</code> 对应的 <strong>mac地址</strong>，有的话就返回，这里显然是不可能会有的。</p>
<blockquote>
<p>可以通过 arp -a 命令查看本机的 arp表都记录了哪些信息</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">$ arp -a
? (192.168.31.1) at 88:c1:97:59:d1:c3 on en0 ifscope [ethernet]
? (224.0.0.251) at 1:0:4e:0:1:fb on en0 ifscope permanent [ethernet]
? (239.255.255.250) at 1:0:3e:7f:ff:fb on en0 ifscope permanent [ethernet]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.看下 <code>192.168.31.7</code> 跟本机IP  <code>192.168.31.6</code>在不在一个局域网下。如果在的话，就在局域网内发一个 arp 广播，内容就是 前面提到的 “谁是 <code>192.168.31.7</code>，告诉一下 <code>192.168.31.6</code>”。</p>
<p>3.如果目的IP跟本机IP不在同一个局域网下，那么会去获取<strong>默认网关的MAC地址</strong>，这里就是指获取<strong>家用路由器的MAC地址</strong>。然后把消息发给家用路由器，让路由器发到互联网，找到下一跳路由器，一跳一跳的发送数据，<strong>直到把消息发到目的IP上，又或者找不到目的地最终被丢弃。</strong></p>
<p>4.第2和第3点都是本地没有查到 ARP 缓存记录的情况，这时候会<strong>把SYN报文放进一个队列（叫unresolved_queue）里暂存起来</strong>，然后发起ARP请求；等ARP层收到ARP回应报文之后，会再从缓存中取出 SYN 报文，组装 MAC 帧头，完成刚刚没完成的发送流程。</p>
<p>如果经过 ARP 流程能正常返回 MAC 地址，那皆大欢喜，直接给<strong>数据链路层</strong>，经过 <code>ring buffer</code> 后传到网卡，发出去。</p>
<p>但因为现在这个IP是瞎编的，因此不可能得到目的地址 MAC ，所以消息也一直没法到数据链路层。<strong>整个流程卡在了ARP流程中。</strong></p>
<p>而<strong>抓包是在数据链路层之后进行的</strong>，因此 TCP 第一次握手的包一直没能抓到，只能抓到为了获得  <code>192.168.31.7</code> 的MAC地址的ARP请求。</p>
<blockquote>
<p>发送数据时，是在经过数据链路层之后的  dev_queue_xmit_nit 方法执行抓包操作的，这是属于网卡驱动层的方法了。</p>
<p>顺带一提，接收端抓包是在  __netif_receive_skb_core 方法里执行的，也属于网卡驱动层。感兴趣的朋友们可以以这个为关键词搜索相关知识点哈</p>
</blockquote>
<p>此时 因为 TCP 协议是可靠的协议，对于 TCP 层来说，第一次握手的消息，已经发出去了，但是一直没有收到 ACK。也不知道消息是出去后是遇到什么事了。为了保证可靠性，它会不断重发。</p>
<p>而每一次重发，都会因为同样的原因（没有目的 MAC 地址）而尬在了 ARP 那个流程里。因此，才看到好几次重复的 ARP 消息。</p>
<p>那回到刚刚的三个问题</p>
<ul>
<li><p>为什么会发 ARP 请求？</p>
<p>因为目的地址是瞎编的，本地ARP表没有目的机器的MAC地址，因此发出ARP消息。</p>
</li>
<li><p>为什么没有 TCP 握手包？</p>
<p>因为协议栈的数据到了网络层后，在数据链路层前，就因为没有目的MAC地址，没法发出。因此抓包软件抓不到相关数据。</p>
</li>
<li><p>为什么 ARP 请求会发那么多遍？</p>
<p>因为 TCP 协议的可靠性，会重发第一次握手的消息，但每一次都因为没有目的 MAC 地址而失败，每次都会发出ARP请求。</p>
</li>
</ul>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>连一个 IP 不存在的主机时，如果<strong>目的IP在局域网内</strong>，则第一次握手会失败，接着不断尝试重发握手的请求。同时，本机会不断发出ARP请求，企图获得目的机器的 MAC 地址。并且，因为没能获得目的 MAC 地址，这些 TCP 握手请求最终都发不出去，</p>
<h3 id="目的IP在局域网外"><a href="#目的IP在局域网外" class="headerlink" title="目的IP在局域网外"></a>目的IP在局域网外</h3><p>上面提到的是，目的 IP 在<strong>局域网内</strong>的情况，下面讨论目的IP在<strong>局域网外</strong>的情况。</p>
<p>瞎编一个不是  <code>192.168.31.xx</code> 形式的 IP 作为这次要用的局域网外IP， 比如 <code>10.225.31.11</code>。</p>
<p>先抓包看一下。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-8.jpg" alt="连一个不存在的IP(局域网外)抓包"></p>
<p>这次的现象是能发出 TCP 第一次握手的 <code>SYN包</code>。</p>
<p>这里有两个问题</p>
<ul>
<li>为什么连局域网外的 IP 现象跟连局域网内不一致？</li>
<li>TCP 第一次握手的重试规律好像不太对？</li>
</ul>
<h4 id="为什么连局域网外的IP现象跟连局域网内不一致？"><a href="#为什么连局域网外的IP现象跟连局域网内不一致？" class="headerlink" title="为什么连局域网外的IP现象跟连局域网内不一致？"></a>为什么连局域网外的IP现象跟连局域网内不一致？</h4><p>这个问题的答案其实在上面 <strong>ARP 的流程</strong>里已经提到过了，如果目的 IP 跟本机 IP 不在同一个局域网下，那么会去获取<strong>默认网关的 MAC 地址</strong>，这里就是指获取<strong>家用路由器的MAC地址</strong>。</p>
<p>此时ARP流程成功返回<strong>家用路由器的 MAC 地址</strong>，数据链路层加入帧头，消息通过网卡发到了<strong>家用路由器上</strong>。</p>
<p>消息会通过互联网一直传递到某个局域网为  <code>10.225.31.xx</code> 的路由器上，那个路由器 发出ARP 请求，询问他们局域网内的机器有没有叫 <code>10.225.31.11</code>的 （结果当然没有）。</p>
<p>最终没能发送成功，发送端也就迟迟收不到目的机的第二次握手响应。</p>
<p>因此触发TCP重传。</p>
<h4 id="TCP第一次握手的重试规律好像不太对？"><a href="#TCP第一次握手的重试规律好像不太对？" class="headerlink" title="TCP第一次握手的重试规律好像不太对？"></a>TCP第一次握手的重试规律好像不太对？</h4><p>在 Linux 中，第一次握手的 <code>SYN</code> 重传次数，是通过 <code>tcp_syn_retries</code> 参数控制的。可以通过下面的方式查看</p>
<pre class="line-numbers language-none"><code class="language-none">$cat /proc/sys/net/ipv4/tcp_syn_retries
6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里的含义是指 <code>syn重传</code> 会发生6次。</p>
<p>而每次重试都会间隔一定的时间，这里的间隔一般是 1s，2s，4s，8s, 16s, 32s .</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-9.jpg" alt="SYN重传"></p>
<p>而事实上，看我的截图，是先重试4次，每次都是1s，之后才是 1s，2s，4s，8s, 16s, 32s 的重试。</p>
<p>这跟我们知道的不太一样。</p>
<p>这个是因为<strong>我用的是macOS抓的包，跟linux就不是一个系统</strong>，各自的TCP协议栈在sync重传方面的实现都可能会有一定的差异。</p>
<p>我还听说 <code>oppo</code> 和 <code>vivo</code> 的 syn重传 是0.5s起步的。而 <code>windows</code> 的 syn重传 还有自己的专利。</p>
<p>这些冷知识大家可以不用在意。面试的时候知道linux的就够了，剩下的可以用来装逼。毕竟面试官不在意”茴”字到底有几种写法。</p>
<h2 id="连IP-地址存在但端口号不存在的主机的握手过程"><a href="#连IP-地址存在但端口号不存在的主机的握手过程" class="headerlink" title="连IP 地址存在但端口号不存在的主机的握手过程"></a>连IP 地址存在但端口号不存在的主机的握手过程</h2><p>前面提到的是IP地址压根就不存在的情况。假如<strong>IP地址存在但端口号是瞎编的</strong>呢？</p>
<h3 id="目的IP是回环地址"><a href="#目的IP是回环地址" class="headerlink" title="目的IP是回环地址"></a>目的IP是回环地址</h3><p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-10.jpg" alt="连回环地址时端口不存在"></p>
<p>现象也比较简单，已经IP地址是存在的，也就是在互联网中这个机器是存在的。</p>
<p>那么我们可以正常发消息到目的IP，因为对应的MAC地址和IP都是正确的，所以，数据从数据链路层到网络层都很OK。</p>
<p>直到传输层，TCP协议在识别到这个端口号对应的进程根本不存在时，就会把数据丢弃，响应一个RST消息给发送端。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-11.jpg" alt="连回环地址时端口不存在"></p>
<h4 id="RST是什么？"><a href="#RST是什么？" class="headerlink" title="RST是什么？"></a>RST是什么？</h4><p>我们都是到TCP正常情况下断开连接是用四次挥手，那是<strong>正常时候</strong>的优雅做法。</p>
<p>但<strong>异常情况</strong>下，收发双方都不一定正常，连挥手这件事本身都可能做不到，所以就需要一个机制去强行关闭连接。</p>
<p><strong>RST</strong> 就是用于这种情况，一般用来<strong>异常地</strong>关闭一个连接。它在TCP包头中，在收到置了这个标志位的数据包后，连接就会被关闭，此时接收到 RST的一方，一般会看到一个 <code>connection reset</code> 或  <code>connection refused</code> 的报错。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-12.jpg" alt="TCP报头RST位"></p>
<h3 id="目的IP在局域网内-1"><a href="#目的IP在局域网内-1" class="headerlink" title="目的IP在局域网内"></a>目的IP在局域网内</h3><p>刚刚提到我的本机IP是 <code>192.168.31.6</code> ，局域网内有台 <code>192.168.31.1</code> 。同样尝试连一个不存在的端口。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-13.jpg" alt="连存在的局域网内IP，端口不存在抓包"></p>
<p>此时现象跟前者一致。</p>
<p>唯一不同的是，前者是回环地址，RST数据是从本机的传输层返回的。而这次的情况，RST数据是从目的机器的传输层返回的。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-14.jpg" alt="连外网地址时端口不存在"></p>
<h3 id="目的IP在局域网外-1"><a href="#目的IP在局域网外-1" class="headerlink" title="目的IP在局域网外"></a>目的IP在局域网外</h3><p>找一个存在的外网ip，这里我拿了<strong>最近刚白嫖的阿里云服务器</strong>地址 <code>47.102.221.141</code> 。（炫耀）</p>
<p>进行连接连接，发现与前面两种情况是一致的，目的机器在收到我的请求后，立马就通过 <strong>RST标志位</strong> 断开了这次的连接。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-15.jpg" alt="连存在的局域网外IP，端口不存在抓包"></p>
<p>这一点跟前面两种情况一致。</p>
<p>熟悉小白的朋友们都知道，每次搞事情做测试，都会用  <code>baidu.com</code> 。</p>
<p>这次也不例外，ping 一下 <code>baidu.com</code> ,获得它的 <code>IP: 220.181.38.148</code> 。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ping</span> baidu.com
PING baidu.com <span class="token punctuation">(</span><span class="token number">220.181</span>.38.148<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">220.181</span>.38.148: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">48</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">35.728</span> ms
<span class="token number">64</span> bytes from <span class="token number">220.181</span>.38.148: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">48</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">38.052</span> ms
<span class="token number">64</span> bytes from <span class="token number">220.181</span>.38.148: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">48</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">37.845</span> ms
<span class="token number">64</span> bytes from <span class="token number">220.181</span>.38.148: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">48</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">37.210</span> ms
<span class="token number">64</span> bytes from <span class="token number">220.181</span>.38.148: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">48</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">38.402</span> ms
<span class="token number">64</span> bytes from <span class="token number">220.181</span>.38.148: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">48</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">37.692</span> ms
^C
--- baidu.com <span class="token function">ping</span> statistics ---
<span class="token number">6</span> packets transmitted, <span class="token number">6</span> packets received, <span class="token number">0.0</span>% packet loss
round-trip min/avg/max/stddev <span class="token operator">=</span> <span class="token number">35.728</span>/37.488/38.402/0.866 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发消息到给百度域名背后的 IP，且瞎随机指定一个端口 <strong>8080</strong>， 抓包。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-16.jpg" alt="连baidu，端口不存在抓包"></p>
<p>现象却不一致。没有 <code>RST</code> 。而且触发了第一次握手的重试消息。这是为什么？</p>
<p>这是因为baidu的机器，作为线上生产的机器，会设置一系列安全策略，比如只对外暴露某些端口，除此之外的端口，都一律拒绝。</p>
<p>所以很多发到 8080端口的消息都<strong>在防火墙这一层就被拒绝掉了</strong>，根本到不了目的主机里，而<strong>RST是在目的主机的TCP/IP协议栈里发出</strong>的，都还没到这一层，就更不可能发RST了。因此发送端发现消息没有回应（因为被防火墙丢了），就会重传。所以才会出现上述抓包里的现象。</p>
<p><img src="https://image.fyxemmmm.cn/blog/images/dir1/tcpnotex-17.jpg" alt="防火墙安全策略"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>连一个 IP 不存在的主机时</p>
<ul>
<li>如果IP在局域网内，会发送N次ARP请求获得目的主机的MAC地址，同时不能发出TCP握手消息。</li>
<li>如果IP在局域网外，会将消息通过路由器发出，但因为最终找不到目的地，触发TCP重试流程。</li>
</ul>
<p>连IP 地址存在但端口号不存在的主机时</p>
<ul>
<li>不管目的IP是回环地址还是局域网内外的IP地址，目的主机的传输层都会在收到握手消息后，发现端口不正确，发出RST消息断开连接。</li>
<li>当然如果目的机器设置了防火墙策略，限制他人将消息发到不对外暴露的端口，那么这种情况，发送端就会不断重试第一次握手。</li>
</ul>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/tcp/">
                                    <span class="chip bg-color">tcp</span>
                                </a>
                            
                                <a href="/tags/%E5%8D%8F%E8%AE%AE/">
                                    <span class="chip bg-color">协议</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,wechat,weibo" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/01/23/liang-ge-wen-jian-de-gong-gong-url/">
                    <div class="card-image">
                        
                        <img src="https://image.fyxemmmm.cn/blog/ins01/ins01-145.jpg" class="responsive-img" alt="找寻两个文件的公共url">
                        
                        <span class="card-title">找寻两个文件的公共url</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            哈希表遍历如何~
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-01-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%80%9A%E7%94%A8/" class="post-category">
                                    通用
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%85%AC%E5%85%B1url/">
                        <span class="chip bg-color">公共url</span>
                    </a>
                    
                    <a href="/tags/%E5%88%86%E6%B2%BB/">
                        <span class="chip bg-color">分治</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/02/11/ji-suan-ji-shi-jian-dao-di-shi-zen-me-lai-de/">
                    <div class="card-image">
                        
                        <img src="https://image.fyxemmmm.cn/blog/ins01/ins01-128.jpg" class="responsive-img" alt="计算机时间到底是怎么来的">
                        
                        <span class="card-title">计算机时间到底是怎么来的</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            原来计算机时间如此复杂
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-02-11
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="post-category">
                                    计算机
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%97%B6%E9%97%B4/">
                        <span class="chip bg-color">计算机时间</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
         <!-- col -->
        <div class="s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2018-2022</span>
            
            <span id="year">2018</span>
            <a href="/about" target="_blank"></a>
            |&nbsp;Powered by&nbsp;<a href="https://github.com/fyxemmmm" target="_blank">yuxuan</a>
            <!-- |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a> -->
            <br>
            愿你历尽千帆，归来任是少年。


            <!-- 
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">150k</span>
            
            
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
             -->


            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <!-- <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/fyxemmmm" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:fyxemmmm@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div> -->
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/fyxemmmm/fyxemmmm.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
